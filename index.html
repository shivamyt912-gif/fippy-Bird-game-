<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Real-Time Chat App with Socket.IO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* Mobile First Design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 16px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.5;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.95);
        }

        /* Header */
        .app-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .app-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Connection Flow Guide */
        .connection-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            position: relative;
        }

        .flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-gray);
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid white;
            box-shadow: var(--box-shadow);
            transition: all 0.3s ease;
        }

        .flow-step.active .step-circle {
            background-color: var(--primary);
            color: white;
        }

        .flow-step.completed .step-circle {
            background-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.8rem;
            text-align: center;
            font-weight: 500;
        }

        .flow-connector {
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background-color: var(--light-gray);
            z-index: 1;
        }

        /* Panels - Mobile friendly */
        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-2px);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }

        .panel-title i {
            font-size: 1.3rem;
        }

        /* My Code Section */
        .my-code-section {
            text-align: center;
        }

        .code-display {
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 8px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 15px 0;
            padding: 15px;
            border: 3px dashed var(--light-gray);
            border-radius: var(--border-radius);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: #d1d9e6;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3ab0d8;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e11575;
        }

        /* Enter Code Section */
        .enter-code-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .code-input {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
            text-transform: uppercase;
            transition: border-color 0.3s;
        }

        .code-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Status Section */
        .status-section {
            text-align: center;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background-color: var(--light-gray);
            border-radius: 50px;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--gray);
        }

        .status-dot.connected {
            background-color: var(--success);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connection-info {
            background-color: rgba(67, 97, 238, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        /* Chat Section */
        .chat-section {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 16px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-container {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: #f5f7fb;
            border-left: 1px solid var(--light-gray);
            border-right: 1px solid var(--light-gray);
            max-height: 50vh;
            min-height: 300px;
        }

        .message {
            margin-bottom: 16px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.received {
            align-self: flex-start;
        }

        .message.sent {
            align-self: flex-end;
            margin-left: auto;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.received .message-content {
            background-color: white;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.sent .message-content {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 5px;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-sender {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .message.sent .message-sender {
            color: rgba(255, 255, 255, 0.9);
        }

        .chat-input-container {
            padding: 16px;
            background-color: white;
            border-top: 1px solid var(--light-gray);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* System Messages */
        .system-message {
            text-align: center;
            margin: 15px 0;
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Instructions */
        .instructions {
            background-color: rgba(76, 201, 240, 0.1);
            padding: 16px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .instructions h3 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        /* Server Status */
        .server-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .server-status.online {
            background: rgba(76, 201, 240, 0.8);
        }

        .server-status.offline {
            background: rgba(247, 37, 133, 0.8);
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 1.3rem;
            }
            
            .code-display {
                font-size: 2rem;
                letter-spacing: 5px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .step-label {
                font-size: 0.7rem;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 500px;
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 24px;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }
        }

        /* Active States for Mobile */
        .btn:active, .code-input:active {
            transform: scale(0.98);
        }

        /* Hide elements when not needed */
        .hidden {
            display: none !important;
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <h1><i class="fas fa-comments"></i> Real-Time Chat App</h1>
            <p>Generate code and connect with Socket.IO</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Connection Flow Guide -->
            <div class="connection-flow">
                <div class="flow-connector"></div>
                <div class="flow-step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Your Code</div>
                </div>
                <div class="flow-step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Enter Code</div>
                </div>
                <div class="flow-step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Chat</div>
                </div>
            </div>

            <!-- My Code Panel -->
            <div class="panel my-code-section" id="myCodePanel">
                <h2 class="panel-title"><i class="fas fa-qrcode"></i> Your Unique Code</h2>
                <p>Share this code with the other person</p>
                
                <div class="code-display" id="myCodeDisplay">-----</div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="generateCodeBtn">
                        <i class="fas fa-sync-alt"></i> Generate New Code
                    </button>
                    <button class="btn btn-secondary" id="copyCodeBtn">
                        <i class="far fa-copy"></i> Copy Code
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" id="nextToEnterCodeBtn">
                        Next Step <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Enter Other's Code Panel -->
            <div class="panel enter-code-section hidden" id="enterCodePanel">
                <h2 class="panel-title"><i class="fas fa-keyboard"></i> Enter Other's Code</h2>
                <p>Enter the code of the person you want to chat with</p>
                
                <div class="enter-code-form">
                    <div class="input-group">
                        <input type="text" class="code-input" id="otherCodeInput" 
                               placeholder="XXXXXX" maxlength="6" autocomplete="off">
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="connectBtn">
                            <i class="fas fa-link"></i> Connect
                        </button>
                        <button class="btn btn-secondary" id="backToMyCodeBtn">
                            <i class="fas fa-arrow-left"></i> Go Back
                        </button>
                    </div>
                </div>
            </div>

            <!-- Connection Status Panel -->
            <div class="panel status-section hidden" id="statusPanel">
                <h2 class="panel-title"><i class="fas fa-plug"></i> Connection Status</h2>
                
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Disconnected</span>
                </div>
                
                <div id="connectionInfo" class="connection-info hidden">
                    <p><strong>Connected with:</strong> <span id="connectedUserName">---</span></p>
                    <p><strong>Code:</strong> <span id="connectedUserCode">---</span></p>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="disconnectBtn">
                        <i class="fas fa-unlink"></i> Disconnect
                    </button>
                    <button class="btn btn-success" id="startChatBtn" class="hidden">
                        <i class="fas fa-comments"></i> Start Chat
                    </button>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-section hidden" id="chatPanel">
                <div class="chat-header">
                    <div>
                        <h3 id="chatWithUserName">---</h3>
                        <p id="chatStatus">Online</p>
                    </div>
                    <button class="btn btn-secondary" id="endChatBtn">
                        <i class="fas fa-phone-slash"></i> End Chat
                    </button>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <!-- Messages will appear here -->
                    <div class="system-message" id="initialChatMessage">
                        Chat started! You can now send messages.
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" 
                           placeholder="Type your message..." autocomplete="off">
                    <button class="send-btn" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> How to Use</h3>
                <ol>
                    <li><strong>Step 1:</strong> Generate your code and send it to the other person</li>
                    <li><strong>Step 2:</strong> Enter the other person's code to connect</li>
                    <li><strong>Step 3:</strong> Start chatting after connection</li>
                </ol>
                <p><strong>Note:</strong> This app uses Socket.IO for real-time communication. Both users need to be online.</p>
            </div>
        </main>
    </div>

    <!-- Server Status Indicator -->
    <div class="server-status" id="serverStatus">
        <i class="fas fa-circle"></i> Connecting...
    </div>

    <!-- Backend Server Simulation -->
    <script>
        // ============================================
        // BACKEND SERVER SIMULATION (Socket.IO Logic)
        // ============================================
        
        // This simulates the server-side logic
        class ChatServer {
            constructor() {
                this.activeConnections = new Map(); // code -> {socketId, userName, partnerSocketId}
                this.socketToCode = new Map(); // socketId -> code
                this.userNames = new Map(); // socketId -> userName
                this.partners = new Map(); // socketId -> partnerSocketId
                
                // In a real app, this would be on a separate server
                console.log('Chat server initialized (simulated)');
            }
            
            // Generate unique code
            generateUniqueCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code;
                do {
                    code = '';
                    for (let i = 0; i < 6; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                } while (this.activeConnections.has(code));
                return code;
            }
            
            // Register new user with generated code
            registerUser(socketId, userName) {
                const code = this.generateUniqueCode();
                this.activeConnections.set(code, {
                    socketId: socketId,
                    userName: userName,
                    status: 'waiting',
                    createdAt: new Date()
                });
                this.socketToCode.set(socketId, code);
                this.userNames.set(socketId, userName);
                
                return code;
            }
            
            // Connect two users using code
            connectUsers(socketId, code, userName) {
                const targetCode = code.toUpperCase();
                
                if (!this.activeConnections.has(targetCode)) {
                    return { success: false, message: 'Code not found' };
                }
                
                const targetUser = this.activeConnections.get(targetCode);
                
                if (targetUser.status === 'connected') {
                    return { success: false, message: 'User already connected' };
                }
                
                // Pair the users
                targetUser.partnerSocketId = socketId;
                targetUser.status = 'connected';
                
                // Register the connecting user
                const currentUser = {
                    socketId: socketId,
                    userName: userName,
                    partnerSocketId: targetUser.socketId,
                    status: 'connected',
                    code: targetCode
                };
                
                this.activeConnections.set(socketId, currentUser);
                this.socketToCode.set(socketId, `paired-${targetCode}`);
                this.userNames.set(socketId, userName);
                this.partners.set(socketId, targetUser.socketId);
                this.partners.set(targetUser.socketId, socketId);
                
                return {
                    success: true,
                    targetUser: targetUser,
                    currentUser: currentUser,
                    code: targetCode
                };
            }
            
            // Send message from one user to another
            sendMessage(fromSocketId, message) {
                const partnerSocketId = this.partners.get(fromSocketId);
                
                if (!partnerSocketId) {
                    return { success: false, message: 'No partner found' };
                }
                
                const fromUserName = this.userNames.get(fromSocketId) || 'Unknown';
                
                return {
                    success: true,
                    fromSocketId: fromSocketId,
                    fromUserName: fromUserName,
                    toSocketId: partnerSocketId,
                    message: message,
                    timestamp: new Date().toISOString()
                };
            }
            
            // Remove user from active connections
            disconnectUser(socketId) {
                const code = this.socketToCode.get(socketId);
                const partnerSocketId = this.partners.get(socketId);
                
                // Clean up all references
                if (code) {
                    this.activeConnections.delete(code);
                }
                
                this.activeConnections.delete(socketId);
                this.socketToCode.delete(socketId);
                this.userNames.delete(socketId);
                
                if (partnerSocketId) {
                    this.partners.delete(socketId);
                    this.partners.delete(partnerSocketId);
                    
                    // Update partner's status
                    const partnerData = this.activeConnections.get(partnerSocketId);
                    if (partnerData) {
                        partnerData.status = 'waiting';
                        delete partnerData.partnerSocketId;
                    }
                    
                    return partnerSocketId;
                }
                
                return null;
            }
            
            // Get user info
            getUserInfo(socketId) {
                return {
                    userName: this.userNames.get(socketId),
                    code: this.socketToCode.get(socketId),
                    partner: this.partners.get(socketId)
                };
            }
        }

        // Initialize the server
        const chatServer = new ChatServer();
        
        // ============================================
        // FRONTEND APPLICATION
        // ============================================
        
        // App State
        const appState = {
            myCode: '',
            otherCode: '',
            connected: false,
            connectedUserName: '',
            connectedUserCode: '',
            chatActive: false,
            myName: `User${Math.floor(Math.random() * 9000) + 1000}`,
            partnerName: '',
            messages: [],
            socketId: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            partnerSocketId: null
        };

        // DOM Elements
        const myCodeDisplay = document.getElementById('myCodeDisplay');
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const nextToEnterCodeBtn = document.getElementById('nextToEnterCodeBtn');
        const otherCodeInput = document.getElementById('otherCodeInput');
        const connectBtn = document.getElementById('connectBtn');
        const backToMyCodeBtn = document.getElementById('backToMyCodeBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectionInfo = document.getElementById('connectionInfo');
        const connectedUserName = document.getElementById('connectedUserName');
        const connectedUserCode = document.getElementById('connectedUserCode');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startChatBtn = document.getElementById('startChatBtn');
        const chatPanel = document.getElementById('chatPanel');
        const chatWithUserName = document.getElementById('chatWithUserName');
        const chatStatus = document.getElementById('chatStatus');
        const endChatBtn = document.getElementById('endChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const initialChatMessage = document.getElementById('initialChatMessage');
        const serverStatus = document.getElementById('serverStatus');
        
        // Panels
        const myCodePanel = document.getElementById('myCodePanel');
        const enterCodePanel = document.getElementById('enterCodePanel');
        const statusPanel = document.getElementById('statusPanel');
        
        // Flow Steps
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

        // Update server status indicator
        function updateServerStatus(connected) {
            if (connected) {
                serverStatus.className = 'server-status online';
                serverStatus.innerHTML = '<i class="fas fa-circle"></i> Server: Online';
            } else {
                serverStatus.className = 'server-status offline';
                serverStatus.innerHTML = '<i class="fas fa-circle"></i> Server: Offline';
            }
        }

        // Initialize with a generated code
        function initApp() {
            // Set server as online
            updateServerStatus(true);
            
            // Generate initial code
            generateNewCode();
            
            // Update flow step
            updateFlowStep(1);
            
            // Set up event listeners
            setupEventListeners();
            
            console.log('App initialized with socket ID:', appState.socketId);
        }

        // Generate new code
        function generateNewCode() {
            appState.myCode = chatServer.generateUniqueCode();
            myCodeDisplay.textContent = appState.myCode;
            
            // Register user with server
            chatServer.registerUser(appState.socketId, appState.myName);
            
            console.log('Generated code:', appState.myCode);
        }

        // Update connection flow visualization
        function updateFlowStep(step) {
            // Reset all steps
            step1.classList.remove('completed', 'active');
            step2.classList.remove('completed', 'active');
            step3.classList.remove('completed', 'active');
            
            // Update based on current step
            if (step === 1) {
                step1.classList.add('active');
            } else if (step === 2) {
                step1.classList.add('completed');
                step2.classList.add('active');
            } else if (step === 3) {
                step1.classList.add('completed');
                step2.classList.add('completed');
                step3.classList.add('active');
            }
        }

        // Update connection status
        function updateConnectionStatus(connected, message = '') {
            appState.connected = connected;
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                connectionInfo.classList.remove('hidden');
                startChatBtn.classList.remove('hidden');
                
                if (message) {
                    showSystemMessage(message);
                }
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                connectionInfo.classList.add('hidden');
                startChatBtn.classList.add('hidden');
                
                if (message) {
                    showSystemMessage(message);
                }
            }
        }

        // Show system message
        function showSystemMessage(message) {
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.textContent = message;
            chatContainer.appendChild(systemMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add message to chat
        function addMessageToChat(text, sender, isSent = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-sender">${sender}</div>
                <div class="message-content">${text}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store message
            appState.messages.push({
                text,
                sender,
                time,
                isSent
            });
        }

        // Simulate receiving a message (for demo)
        function simulateIncomingMessage() {
            if (!appState.chatActive || !appState.partnerSocketId) return;
            
            // Only simulate if we haven't received a message in the last 10 seconds
            const lastMessageTime = appState.messages
                .filter(m => !m.isSent)
                .sort((a, b) => new Date(b.time) - new Date(a.time))[0];
                
            if (lastMessageTime && (Date.now() - new Date(lastMessageTime.time).getTime()) < 10000) {
                return;
            }
            
            setTimeout(() => {
                if (!appState.chatActive) return;
                
                const responses = [
                    "Hi there! How are you?",
                    "That's interesting! Tell me more.",
                    "I agree with you on that point.",
                    "What do you think about this weather?",
                    "Thanks for chatting with me!",
                    "Have you used this app before?",
                    "This real-time chat is working well!",
                    "What are your plans for today?"
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                // Simulate message from partner
                const messageData = {
                    fromSocketId: appState.partnerSocketId,
                    fromUserName: appState.partnerName,
                    message: randomResponse,
                    timestamp: new Date().toISOString()
                };
                
                // Add to chat
                addMessageToChat(messageData.message, appState.partnerName, false);
            }, 3000 + Math.random() * 7000);
        }

        // Send a message
        function sendMessage() {
            const messageText = chatInput.value.trim();
            
            if (!messageText || !appState.chatActive) {
                return;
            }
            
            // Add my message to chat
            addMessageToChat(messageText, 'You', true);
            
            // Clear input
            chatInput.value = '';
            
            // Send to server (simulated)
            const result = chatServer.sendMessage(appState.socketId, messageText);
            
            if (result.success) {
                console.log('Message sent:', messageText);
                
                // Start simulation for incoming response
                simulateIncomingMessage();
            }
        }

        // Connect to another user's code
        function connectToCode() {
            const code = otherCodeInput.value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                alert('Please enter a 6-character code');
                return;
            }
            
            appState.otherCode = code;
            
            // Show connecting status
            updateConnectionStatus(false, 'Connecting...');
            
            // Simulate connection process
            setTimeout(() => {
                // Connect with server
                const result = chatServer.connectUsers(
                    appState.socketId, 
                    code, 
                    appState.myName
                );
                
                if (result.success) {
                    // Successfully connected
                    appState.partnerName = result.targetUser.userName;
                    appState.partnerSocketId = result.targetUser.socketId;
                    appState.connectedUserCode = result.code;
                    
                    updateConnectionStatus(true, 'Connection successful!');
                    
                    // Update UI
                    connectedUserName.textContent = appState.partnerName;
                    connectedUserCode.textContent = result.code;
                    
                    // Move to status panel
                    enterCodePanel.classList.add('hidden');
                    statusPanel.classList.remove('hidden');
                    updateFlowStep(3);
                    
                    // Show success message
                    showSystemMessage(`You are now connected with ${appState.partnerName}!`);
                    
                    console.log('Connected with:', appState.partnerName);
                } else {
                    // Connection failed
                    alert(result.message);
                    updateConnectionStatus(false, 'Connection failed');
                }
            }, 1000);
        }

        // Start chat
        function startChat() {
            appState.chatActive = true;
            
            // Update UI
            statusPanel.classList.add('hidden');
            chatPanel.classList.remove('hidden');
            
            // Set chat partner name
            chatWithUserName.textContent = appState.partnerName;
            chatStatus.textContent = 'Online';
            
            // Show initial message
            initialChatMessage.classList.remove('hidden');
            
            // Focus on chat input
            setTimeout(() => {
                chatInput.focus();
            }, 300);
            
            // Start simulating incoming messages
            simulateIncomingMessage();
        }

        // End chat and disconnect
        function endChat() {
            appState.chatActive = false;
            appState.connected = false;
            
            // Disconnect from server
            const partnerSocketId = chatServer.disconnectUser(appState.socketId);
            
            // Reset UI
            chatPanel.classList.add('hidden');
            myCodePanel.classList.remove('hidden');
            
            // Clear chat
            chatContainer.innerHTML = '<div class="system-message" id="initialChatMessage">Chat started! You can now send messages.</div>';
            initialChatMessage.id = 'initialChatMessage';
            
            // Reset app state
            appState.messages = [];
            appState.otherCode = '';
            appState.partnerName = '';
            appState.partnerSocketId = null;
            otherCodeInput.value = '';
            
            // Generate new code
            generateNewCode();
            
            // Update flow
            updateFlowStep(1);
            updateConnectionStatus(false, 'Disconnected');
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Generate new code
            generateCodeBtn.addEventListener('click', () => {
                generateNewCode();
                
                // Show feedback
                const originalText = generateCodeBtn.innerHTML;
                generateCodeBtn.innerHTML = '<i class="fas fa-check"></i> Code Generated';
                generateCodeBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    generateCodeBtn.innerHTML = originalText;
                    generateCodeBtn.classList.remove('btn-success');
                }, 1500);
            });
            
            // Copy code to clipboard
            copyCodeBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(appState.myCode).then(() => {
                    // Show success feedback
                    const originalText = copyCodeBtn.innerHTML;
                    copyCodeBtn.innerHTML = '<i class="fas fa-check"></i> Code Copied';
                    copyCodeBtn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        copyCodeBtn.innerHTML = originalText;
                        copyCodeBtn.classList.remove('btn-success');
                    }, 2000);
                });
            });
            
            // Move to enter code panel
            nextToEnterCodeBtn.addEventListener('click', () => {
                myCodePanel.classList.add('hidden');
                enterCodePanel.classList.remove('hidden');
                updateFlowStep(2);
                otherCodeInput.focus();
            });
            
            // Connect to other user's code
            connectBtn.addEventListener('click', connectToCode);
            
            // Enter key to connect
            otherCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    connectToCode();
                }
            });
            
            // Auto-uppercase and limit code input
            otherCodeInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (this.value.length > 6) {
                    this.value = this.value.substring(0, 6);
                }
            });
            
            // Back to my code panel
            backToMyCodeBtn.addEventListener('click', () => {
                enterCodePanel.classList.add('hidden');
                myCodePanel.classList.remove('hidden');
                updateFlowStep(1);
            });
            
            // Disconnect
            disconnectBtn.addEventListener('click', () => {
                appState.connected = false;
                statusPanel.classList.add('hidden');
                myCodePanel.classList.remove('hidden');
                updateFlowStep(1);
                updateConnectionStatus(false, 'Disconnected');
                
                // Disconnect from server
                chatServer.disconnectUser(appState.socketId);
            });
            
            // Start chat
            startChatBtn.addEventListener('click', startChat);
            
            // End chat
            endChatBtn.addEventListener('click', endChat);
            
            // Send message on button click
            sendMessageBtn.addEventListener('click', sendMessage);
            
            // Send message on Enter key
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Mobile-specific optimizations
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Prevent zoom on input focus for mobile
            chatInput.addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({behavior: 'smooth', block: 'center'});
                }, 300);
            });
        }

        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Prevent accidental refresh
        window.addEventListener('beforeunload', (e) => {
            if (appState.chatActive) {
                e.preventDefault();
                e.returnValue = 'You are leaving the chat. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>